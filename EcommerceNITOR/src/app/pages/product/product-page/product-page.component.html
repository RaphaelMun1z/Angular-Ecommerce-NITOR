@if (systemStatus.isSystemOffline()) {
    <div class="h-screen flex flex-col items-center justify-center bg-gray-50/50 px-4 text-center animate-fade-in">
        <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 max-w-sm w-full">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-amber-50 text-amber-500 mb-6">
                <i class="ph-duotone ph-cloud-slash text-3xl"></i>
            </div>
            <h2 class="text-lg font-bold text-gray-900 mb-2">Conexão Indisponível</h2>
            <p class="text-xs text-gray-500 mb-8 leading-relaxed px-2">
                Não conseguimos conectar ao servidor. Verifique sua internet ou tente novamente em alguns instantes.
            </p>
            <button (click)="retry()" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl transition-all flex items-center justify-center gap-2 cursor-pointer active:scale-95 text-sm">
                <i class="ph-bold ph-arrows-clockwise"></i>
                Tentar Novamente
            </button>
        </div>
    </div>
}

@else if (loading()) {
    <div class="h-screen flex flex-col items-center justify-center bg-white animate-fade-in relative overflow-hidden">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-40 h-40 bg-brand-50 rounded-full animate-ping opacity-20"></div>
            <div class="absolute w-64 h-64 bg-brand-50 rounded-full animate-ping opacity-10" style="animation-delay: 0.5s"></div>
        </div>

        <div class="relative flex flex-col items-center">
            <div class="relative w-24 h-24 mb-8">
                <svg class="w-full h-full animate-spin" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#f1f5f9" stroke-width="8" />
                    <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" 
                            stroke-dasharray="70 200" stroke-linecap="round" class="text-brand-600" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="bg-brand-600 p-3 rounded-2xl shadow-lg shadow-brand-500/30">
                        <i class="ph-fill ph-package text-white text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="text-center space-y-2">
                <h3 class="text-sm font-black text-gray-900 uppercase tracking-[0.3em] ml-1">Sincronizando</h3>
                <div class="flex items-center justify-center gap-1">
                    <p class="text-xs text-gray-400 font-medium italic">Preparando detalhes do produto</p>
                    <span class="flex gap-0.5">
                        <span class="w-1 h-1 bg-brand-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                        <span class="w-1 h-1 bg-brand-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-1 h-1 bg-brand-400 rounded-full animate-bounce" style="animation-delay: 0.3s"></span>
                    </span>
                </div>
            </div>
        </div>
    </div>
}  

@else {
    @if (product(); as p) {
        <main class="container mx-auto px-4 pt-28 pb-12 animate-fade-in">
            
            <nav class="flex text-sm text-gray-500 mb-8 overflow-x-auto whitespace-nowrap pb-2 items-center">
                <a routerLink="/" class="hover:text-brand-600 transition-colors flex items-center gap-1 font-medium">
                    <i class="ph-fill ph-house"></i> Home
                </a>
                <i class="ph-bold ph-caret-right text-[10px] mx-3 text-gray-300"></i>
                <a class="hover:text-brand-600 transition-colors cursor-pointer font-medium">
                    {{ p.categoria?.nome || 'Geral' }}
                </a>
                <i class="ph-bold ph-caret-right text-[10px] mx-3 text-gray-300"></i>
                <span class="text-gray-900 font-bold truncate">{{ p.titulo }}</span>
            </nav>
            
            <div class="bg-white rounded-3xl p-6 lg:p-10 shadow-sm border border-gray-100 flex flex-col lg:flex-row gap-12">
                
                <div class="w-full lg:w-7/12 xl:w-1/2 flex flex-col gap-6">
                    
                    <div 
                    class="relative w-full aspect-square bg-white rounded-3xl overflow-hidden border border-gray-100 group cursor-zoom-in flex items-center justify-center shadow-inner"
                    (mousemove)="onMouseMove($event)"
                    (mouseleave)="onMouseLeave()">
                    
                        <img 
                        [src]="currentImage()" 
                        [alt]="p.titulo"
                        class="w-full h-full object-contain p-8 transition-transform duration-200 ease-out z-0"
                        [style.transform]="zoomTransform()"
                        [style.transform-origin]="zoomOrigin()">
                        
                        <div class="absolute top-6 left-6 flex flex-col gap-3 z-10 pointer-events-none">
                            @if (p.precoPromocional) {
                                <div class="flex items-center gap-2 bg-red-600 text-white text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-xl shadow-sm">
                                    <i class="ph-bold ph-percent"></i>
                                    {{ discountPercentage() }}% OFF
                                </div>
                            }
                            @if (p.estoque > 0) {
                                <div class="bg-white/90 backdrop-blur border border-green-200 text-green-700 text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-xl shadow-sm flex items-center gap-2">
                                    <span class="relative flex h-2 w-2">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                    </span>
                                    Pronta Entrega
                                </div>
                            } @else {
                                <div class="bg-gray-900/90 backdrop-blur text-white text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-xl shadow-sm flex items-center gap-2">
                                    <i class="ph-bold ph-prohibit"></i>
                                    Esgotado
                                </div>
                            }
                        </div>
                        
                        <button (click)="toggleFavorite()" 
                                class="absolute top-6 right-6 p-4 rounded-2xl shadow-sm backdrop-blur-md transition-all z-20 group/heart border border-gray-100 hover:scale-110 active:scale-95"
                                [ngClass]="favoritoService.isFavorito(p.id) 
                                    ? 'bg-red-50 text-red-500 border-red-100' 
                                    : 'bg-white/90 text-gray-400 hover:text-red-500 hover:bg-white'">
                            <i [class]="favoritoService.isFavorito(p.id) ? 'ph-fill ph-heart text-2xl' : 'ph-bold ph-heart text-2xl'"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-5 gap-4">
                        @for (img of productImages(); track $index) {
                            <div 
                            (click)="changeImage(img)"
                            class="aspect-square rounded-2xl overflow-hidden border-2 cursor-pointer transition-all bg-white p-1.5"
                            [ngClass]="currentImage() === img ? 'border-brand-500 ring-4 ring-brand-50' : 'border-transparent hover:border-gray-200'">
                                <img [src]="img" class="w-full h-full object-contain rounded-xl">
                            </div>
                        }
                    </div>
                </div>
                
                <div class="w-full lg:w-5/12 xl:w-1/2 flex flex-col">
                    <div class="mb-8 border-b border-gray-50 pb-8">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-[10px] font-black text-brand-700 bg-brand-50 px-3 py-1.5 rounded-lg uppercase tracking-[0.2em] border border-brand-100">
                                {{ productExtras.brand }}
                            </span>
                            <span class="text-[10px] font-mono font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-md border border-gray-100 uppercase">REF: {{ p.codigoControle }}</span>
                        </div>
                        
                        <h1 class="text-3xl md:text-4xl font-black text-gray-900 leading-tight mb-4 tracking-tight">
                            {{ p.titulo }}
                        </h1>
                        
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-1.5 bg-yellow-50 px-3 py-1.5 rounded-xl border border-yellow-100">
                                <div class="flex text-sm gap-0.5 text-yellow-400">
                                    <i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star-half"></i>
                                </div>
                                <span class="font-bold text-gray-900 text-xs ml-1">{{ productExtras.rating }}</span>
                            </div>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-500 text-xs font-medium"><strong>{{ productExtras.reviewsCount }}</strong> avaliações</span>
                        </div>
                    </div>
                    
                    <div class="mb-10">
                        <div class="flex items-baseline gap-3 flex-wrap mb-2">
                            @if (p.precoPromocional) {
                                <span class="text-gray-400 line-through text-xl font-medium decoration-red-400/50">{{ p.preco | currency:'BRL' }}</span>
                            }
                        </div>
                        
                        <div class="flex items-end gap-2 mb-4">
                            <span class="text-base font-bold text-gray-400 mb-2">R$</span>
                            <span class="text-6xl font-black text-gray-900 tracking-tighter leading-none">
                                {{ finalPrice() | number:'1.2-2' }}
                            </span>
                            <span class="text-xs font-bold text-gray-400 mb-2 ml-1">à vista</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <div class="group relative flex flex-col items-center justify-center p-3 rounded-2xl border border-gray-100 bg-white hover:border-green-200 hover:bg-green-50/30 hover:shadow-md transition-all cursor-pointer h-full">
                                <div class="flex items-center gap-1.5 mb-1.5">
                                    <i class="ph-bold ph-pix-logo text-green-600 text-lg"></i>
                                    <span class="text-[10px] font-bold text-gray-700 uppercase tracking-wide">Pix</span>
                                </div>
                                <span class="text-[9px] font-bold text-green-600 bg-green-100/50 px-2 py-0.5 rounded-full">-5% OFF</span>
                            </div>

                            <div class="group flex flex-col items-center justify-center p-3 rounded-2xl border border-gray-100 bg-white hover:border-gray-300 hover:shadow-md transition-all cursor-pointer h-full">
                                <div class="flex items-center gap-1.5 mb-1.5">
                                    <i class="ph-bold ph-barcode text-gray-500 text-lg"></i>
                                    <span class="text-[10px] font-bold text-gray-700 uppercase tracking-wide">Boleto</span>
                                </div>
                                <span class="text-[9px] text-gray-400 font-medium">À vista</span>
                            </div>

                            <div class="group relative flex flex-col items-center justify-center p-3 rounded-2xl border border-gray-100 bg-white hover:border-brand-200 hover:bg-brand-50/10 hover:shadow-md transition-all cursor-pointer h-full">
                                <div class="flex items-center gap-1.5 mb-1.5">
                                    <i class="ph-bold ph-credit-card text-brand-600 text-lg"></i>
                                    <span class="text-[10px] font-bold text-gray-700 uppercase tracking-wide">Cartão</span>
                                </div>
                                <span class="text-[9px] text-brand-600 font-bold bg-brand-50/50 px-2 py-0.5 rounded-full">12x</span>

                                <div class="absolute right-0 top-full mt-3 w-64 bg-white border border-gray-100 rounded-2xl shadow-lg z-30 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0 pointer-events-none group-hover:pointer-events-auto overflow-hidden">
                                    <div class="bg-gray-50/50 px-4 py-3 border-b border-gray-50 flex justify-between items-center">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Parcelamento</span>
                                        <i class="ph-bold ph-cardholder text-brand-400"></i>
                                    </div>
                                    <div class="max-h-48 overflow-y-auto p-2">
                                        @for (i of [1,2,3,6,10,12]; track i) {
                                            <div class="flex justify-between items-center px-3 py-2 hover:bg-brand-50 rounded-xl text-xs transition-colors">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-bold text-brand-600 w-5 text-right">{{ i }}x</span>
                                                    <span class="text-gray-500">de</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="font-bold text-gray-900">{{ (finalPrice() / i) | currency:'BRL' }}</span>
                                                    @if(i <= 3) { <span class="text-[9px] text-green-600 bg-green-50 px-1.5 rounded font-bold">S/J</span> }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 mb-10">
                        <div class="flex items-center justify-between border-2 border-gray-100 rounded-2xl bg-white w-full sm:w-44 hover:border-gray-300 transition-colors p-1.5">
                            <button class="w-11 h-11 flex items-center justify-center text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-all active:scale-90" 
                                    (click)="updateQty(-1)" [disabled]="quantity() <= 1">
                                <i class="ph-bold ph-minus"></i>
                            </button>
                            <input type="number" [value]="quantity()" readonly class="w-14 text-center font-black text-xl text-gray-900 outline-none border-none p-0 bg-transparent">
                            <button class="w-11 h-11 flex items-center justify-center text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-all active:scale-90" 
                                    (click)="updateQty(1)">
                                <i class="ph-bold ph-plus"></i>
                            </button>
                        </div>

                        <button (click)="addToCart()" [disabled]="p.estoque <= 0"
                                class="flex-1 bg-gray-900 hover:bg-brand-600 text-white font-bold h-16 rounded-2xl shadow-md transition-all transform active:scale-[0.98] flex items-center justify-center gap-3 text-lg disabled:opacity-50 disabled:bg-gray-400 shadow-brand-900/10">
                            <i class="ph-bold ph-shopping-cart text-2xl"></i>
                            <span>{{ p.estoque > 0 ? 'Adicionar ao Carrinho' : 'Produto Esgotado' }}</span>
                        </button>
                    </div>
                
                    <app-shipping-calculator [initialZipCode]="zipCode()" (shippingSelected)="calculateShipping()"></app-shipping-calculator>
                </div>
            </div>
            
            <div class="mt-16 bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                <nav class="border-b border-gray-100 bg-gray-50/20 px-8 flex gap-10">
                    <button (click)="setActiveTab('overview')" class="relative py-6 text-sm font-bold transition-colors focus:outline-none" [class.text-brand-600]="activeTab() === 'overview'" [class.text-gray-400]="activeTab() !== 'overview'">
                        Visão Geral
                        <span class="absolute bottom-0 left-0 w-full h-1 bg-brand-500 rounded-t-full transition-transform duration-300" [class.scale-x-100]="activeTab() === 'overview'" [class.scale-x-0]="activeTab() !== 'overview'"></span>
                    </button>
                    <button (click)="setActiveTab('specs')" class="relative py-6 text-sm font-bold transition-colors focus:outline-none" [class.text-brand-600]="activeTab() === 'specs'" [class.text-gray-400]="activeTab() !== 'specs'">
                        Especificações
                        <span class="absolute bottom-0 left-0 w-full h-1 bg-brand-500 rounded-t-full transition-transform duration-300" [class.scale-x-100]="activeTab() === 'specs'" [class.scale-x-0]="activeTab() !== 'specs'"></span>
                    </button>
                    <button (click)="setActiveTab('reviews')" class="relative py-6 text-sm font-bold transition-colors focus:outline-none" [class.text-brand-600]="activeTab() === 'reviews'" [class.text-gray-400]="activeTab() !== 'reviews'">
                        Avaliações <span class="ml-2 bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full text-[10px]">{{ productExtras.reviewsCount }}</span>
                        <span class="absolute bottom-0 left-0 w-full h-1 bg-brand-500 rounded-t-full transition-transform duration-300" [class.scale-x-100]="activeTab() === 'reviews'" [class.scale-x-0]="activeTab() !== 'reviews'"></span>
                    </button>
                </nav>
                
                <div class="p-10 lg:p-16 min-h-[400px]">
                    @if (activeTab() === 'overview') {
                        <div class="animate-fade-in max-w-5xl mx-auto flex flex-col md:flex-row gap-16 items-start">
                            <div class="flex-1">
                                <h2 class="text-3xl font-black text-gray-900 mb-6 tracking-tight">Sobre este material</h2>
                                <div class="prose prose-gray max-w-none">
                                    <p class="text-gray-600 leading-relaxed text-lg whitespace-pre-line">{{ p.descricao }}</p>
                                </div>
                            </div>
                            <div class="w-full md:w-96 h-96 bg-gray-50 rounded-3xl border border-gray-100 flex items-center justify-center p-10 overflow-hidden shadow-inner shrink-0">
                                <img [src]="currentImage()" class="w-full h-full object-contain opacity-90 mix-blend-multiply hover:scale-110 transition-transform duration-700">
                            </div>
                        </div>
                    }
                    
                    @if (activeTab() === 'specs') {
                        <div class="animate-fade-in max-w-4xl mx-auto border border-gray-100 rounded-2xl overflow-hidden shadow-sm">
                            <table class="w-full text-sm">
                                <tbody class="divide-y divide-gray-50">
                                    <tr class="hover:bg-gray-50/50 transition-colors">
                                        <td class="py-5 px-10 font-black text-gray-900 uppercase tracking-widest text-[10px] bg-gray-50/50 w-1/3">Dimensões</td>
                                        <td class="py-5 px-10 text-gray-600 font-medium">{{ p.dimensoes || 'Informação não disponível' }}</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50/50 transition-colors">
                                        <td class="py-5 px-10 font-black text-gray-900 uppercase tracking-widest text-[10px] bg-gray-50/50 w-1/3">Peso Total</td>
                                        <td class="py-5 px-10 text-gray-600 font-medium">{{ p.pesoKg ?? '—' }} kg</td>
                                    </tr>
                                    @for (spec of productExtras.specs; track spec.label) {
                                        <tr class="hover:bg-gray-50/50 transition-colors">
                                            <td class="py-5 px-10 font-black text-gray-900 uppercase tracking-widest text-[10px] bg-gray-50/50 w-1/3">{{ spec.label }}</td>
                                            <td class="py-5 px-10 text-gray-600 font-medium">{{ spec.value }}</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    
                    @if (activeTab() === 'reviews') {
                        <div class="animate-fade-in max-w-3xl mx-auto space-y-12">
                            @for (review of productExtras.reviews; track review.user) {
                                <div class="flex gap-6 pb-12 border-b border-gray-50 last:border-0 last:pb-0">
                                    <div class="w-14 h-14 rounded-2xl bg-brand-50 flex items-center justify-center text-brand-700 font-black text-sm shrink-0 border border-brand-100 shadow-sm">
                                        {{ review.user.substring(0,2) }}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-bold text-gray-900 text-base">{{ review.user }}</h4>
                                            <span class="text-[10px] font-black text-gray-400 uppercase tracking-[0.15em] bg-gray-50 px-3 py-1 rounded-full border border-gray-100">{{ review.date }}</span>
                                        </div>
                                        <div class="flex text-yellow-400 text-xs mb-4 gap-0.5">
                                            @for (star of [1,2,3,4,5]; track star) { 
                                                <i [class]="review.rating >= star ? 'ph-fill ph-star' : 'ph-fill ph-star text-gray-200'"></i> 
                                            }
                                        </div>
                                        <p class="text-gray-600 leading-relaxed text-sm italic font-medium">"{{ review.text }}"</p>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </main>
    }
    @else {
        <div class="h-screen flex flex-col items-center justify-center bg-gray-50/50 px-4 text-center animate-fade-in">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 max-w-sm w-full relative overflow-hidden">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gray-50 text-gray-300 mb-6 shadow-inner">
                    <i class="ph-duotone ph-magnifying-glass text-3xl"></i>
                </div>
                
                <h2 class="text-lg font-bold text-gray-900 mb-2 tracking-tight">Material não encontrado</h2>
                <p class="text-xs text-gray-500 mb-8 leading-relaxed">
                    Não conseguimos localizar o material que você procura. Ele pode ter sido removido ou o link está incorreto.
                </p>
                
                <div class="flex flex-col gap-2">
                    <button routerLink="/" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl transition-all flex items-center justify-center gap-2 cursor-pointer active:scale-95 text-sm shadow-brand-600/10">
                        <i class="ph-bold ph-shopping-bag"></i>
                        Explorar Catálogo
                    </button>
                    <button (click)="retry()" class="w-full bg-white border border-gray-200 text-gray-600 font-bold py-3.5 rounded-xl hover:bg-gray-50 transition-all flex items-center justify-center gap-2 cursor-pointer active:scale-95 text-sm">
                        <i class="ph-bold ph-arrows-clockwise"></i>
                        Tentar Novamente
                    </button>
                </div>
            </div>
        </div>
    }
}